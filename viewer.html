<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gaol Tactician (Viewer)</title>
    <style>
        /* Viewerç”¨ã®æœ€å°é™ã®CSS */
        :root {
            --primary: #007bff; --master-bg: #fff3cd; --master-border: #ffc107; --lv99-bg: #e2e6ea; --lv99-border: #adb5bd;
            --bg: #f4f4f9; --border: #ddd;
        }
        body { font-family: sans-serif; margin: 0; padding: 20px 10px; background: var(--bg); }
        
        h2 { text-align: center; color: #333; margin-top: 0; font-size: 1.2rem;}
        
        .boss-header { display: grid; grid-template-columns: 100px 1fr 1fr 1fr; gap: 4px; margin-bottom: 5px; text-align: center; font-size: 0.85em; font-weight: bold; color: #555;}
        .boss-name { background: #fff; border: 1px solid #999; border-radius: 4px; padding: 5px; }

        .grid-row { display: grid; grid-template-columns: 100px 1fr 1fr 1fr; gap: 4px; margin-bottom: 6px; min-height: 50px; }
        
        .player-info { display: flex; flex-direction: column; gap: 2px; justify-content: center; background: white; border: 1px solid var(--border); padding: 5px; border-radius: 4px; }
        .p-name { font-weight: bold; font-size: 0.9rem; word-break: break-all; }
        .p-jobs { font-size: 0.7rem; color: #666; line-height: 1.2; }

        .job-slot { background: white; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; position: relative; }
        .job-slot.has-job { background-color: #fff; border: 2px solid #555; color: #333; }
        .slot-mark-master { position: absolute; top: 0; right: 2px; color: #ffc107; font-size: 0.7rem; }

        .alert-box { background: #e2e6ea; padding: 10px; text-align: center; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem;}
        
        @media (max-width: 400px) {
            .grid-row, .boss-header { grid-template-columns: 80px 1fr 1fr 1fr; }
            .job-slot { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div class="alert-box">
        ğŸ“ å…±æœ‰ã•ã‚ŒãŸä½œæˆ¦ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ (é–²è¦§å°‚ç”¨)
    </div>

    <div class="boss-header">
        <div>MEMBER</div>
        <div class="boss-name" id="boss-1">-</div>
        <div class="boss-name" id="boss-2">-</div>
        <div class="boss-name" id="boss-3">-</div>
    </div>

    <div id="battle-grid"></div>

<script>
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const sharedData = params.get('s');
        if (sharedData) {
            renderFromUrl(sharedData);
        } else {
            document.body.innerHTML = '<div style="text-align:center; margin-top:50px;">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
        }
    };

    function renderFromUrl(base64) {
        try {
            const jsonStr = decodeURIComponent(escape(atob(base64)));
            const data = JSON.parse(jsonStr);

            // ãƒœã‚¹å
            if(data.bo) {
                document.getElementById('boss-1').textContent = data.bo[0] || "-";
                document.getElementById('boss-2').textContent = data.bo[1] || "-";
                document.getElementById('boss-3').textContent = data.bo[2] || "-";
            }

            const grid = document.getElementById('battle-grid');
            const rows = data.r || [];

            // 6è¡Œæç”»
            rows.forEach(row => {
                const div = document.createElement('div');
                div.className = 'grid-row';

                if (row) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
                    const pInfo = document.createElement('div');
                    pInfo.className = 'player-info';
                    const nameDiv = document.createElement('div'); nameDiv.className = 'p-name'; nameDiv.textContent = row.n;
                    
                    // ã‚¸ãƒ§ãƒ–ä¸€è¦§ï¼ˆæ–‡å­—åˆ—åŒ–ï¼‰
                    const mStr = (row.m || []).join(' '); // ãƒã‚¹ã‚¿ãƒ¼
                    // const lStr = (row.l || []).join(' '); // Lv99 (è¡¨ç¤ºã—ãŸã‘ã‚Œã°)
                    
                    const jobDiv = document.createElement('div'); jobDiv.className = 'p-jobs'; 
                    jobDiv.textContent = mStr; // ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒã‚¹ã‚¿ãƒ¼ã‚¸ãƒ§ãƒ–ã ã‘è¡¨ç¤ºãªã©

                    pInfo.appendChild(nameDiv);
                    pInfo.appendChild(jobDiv);
                    div.appendChild(pInfo);

                    // 3æˆ¦åˆ†ã®ã‚¹ãƒ­ãƒƒãƒˆ
                    const slots = row.s || [null, null, null];
                    slots.forEach(job => {
                        const slot = document.createElement('div');
                        slot.className = 'job-slot';
                        if(job) {
                            slot.classList.add('has-job');
                            slot.textContent = job;
                            // ãƒã‚¹ã‚¿ãƒ¼åˆ¤å®šï¼ˆãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚‹å ´åˆï¼‰
                            if(row.m && row.m.includes(job)) {
                                slot.innerHTML += '<span class="slot-mark-master">â˜…</span>';
                            }
                        }
                        div.appendChild(slot);
                    });

                } else {
                    // ç©ºè¡Œ
                    div.innerHTML = `<div class="player-info">-</div><div class="job-slot"></div><div class="job-slot"></div><div class="job-slot"></div>`;
                }
                grid.appendChild(div);
            });

        } catch(e) {
            console.error(e);
            alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }
</script>
</body>
</html>
