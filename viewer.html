<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gaol Tactician (Viewer)</title>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --info: #17a2b8;
            --danger: #dc3545;
            --bg: #f4f4f9;
            --border: #ddd;
            --master-bg: #fff3cd;
            --master-border: #ffc107;
            --lv99-bg: #e2e6ea;
            --lv99-border: #adb5bd;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px 10px;
            background: var(--bg);
        }

        .alert-box {
            background: #e2e6ea;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border: 1px solid #ccc;
        }

        .boss-header {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 5px;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
        }

        .boss-name {
            background: #fff;
            border: 1px solid #999;
            border-radius: 4px;
            padding: 5px;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr;
            gap: 4px;
            margin-bottom: 6px;
            min-height: 50px;
        }

        .p-name-box {
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--border);
            padding: 5px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .job-slot {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            position: relative;
        }

        .job-slot.has-job {
            background-color: #fff;
            border: 2px solid #555;
            color: #333;
        }

        .job-slot.target-master {
            background-color: var(--master-bg);
            border: 2px solid var(--master-border);
        }

        .job-slot.target-lv99 {
            background-color: var(--lv99-bg);
            border: 2px solid var(--lv99-border);
        }

        .slot-mark-master {
            position: absolute;
            top: 0;
            right: 2px;
            color: #ffc107;
            font-size: 0.7rem;
        }

        @media (max-width: 400px) {

            .grid-row,
            .boss-header {
                grid-template-columns: 80px 1fr 1fr 1fr;
            }

            .job-slot {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>

    <div class="alert-box">
        ğŸ“ å…±æœ‰ã•ã‚ŒãŸä½œæˆ¦ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ (é–²è¦§å°‚ç”¨)
    </div>

    <div class="boss-header">
        <div>MEMBER</div>
        <div class="boss-name" id="boss-1">-</div>
        <div class="boss-name" id="boss-2">-</div>
        <div class="boss-name" id="boss-3">-</div>
    </div>

    <div id="battle-grid"></div>

    <script>
        // å¾©å…ƒç”¨ãƒ‡ãƒ¼ã‚¿ (index.htmlã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)
        const JOBS = ['æˆ¦', 'ãƒ¢', 'ç™½', 'é»’', 'èµ¤', 'ã‚·', 'ãƒŠ', 'æš—', 'ç£', 'è©©', 'ç‹©', 'ä¾', 'å¿', 'ç«œ', 'å¬', 'é’', 'ã‚³', 'ã‹', 'è¸Š', 'å­¦', 'é¢¨', 'å‰£'];
        const BOSS_DATA = [{ name: "Ongo", weak: "åœŸ/é­”" }, { name: "Xevioso", weak: "çª/ã‚¯ãƒª" }, { name: "Arebati", weak: "çª/é " }, { name: "Ngai", weak: "æ‰“" }, { name: "Kalunga", weak: "æ–¬" }, { name: "Mboze", weak: "æ–¬" }, { name: "Bumba", weak: "é­”/ç‰¹" }, { name: "Gogmagog", weak: "æ‰“" }, { name: "Aristaeus", weak: "æ–¬" }, { name: "Raskovniche", weak: "é¢¨/é­”" }, { name: "Marmorkrebs", weak: "é›·/é­”" }, { name: "Gigelorum", weak: "æ‰“" }, { name: "Procne", weak: "çª" }, { name: "Henwen", weak: "æ‰“" }, { name: "Sgili", weak: "ç«/é­”" }, { name: "U Bnai", weak: "ç«/é­”" }, { name: "Dealan-dhe", weak: "çª" }, { name: "---", weak: "" }];

        window.onload = function () {
            const params = new URLSearchParams(window.location.search);
            const sharedData = params.get('s');
            if (sharedData) {
                renderFromUrl(sharedData);
            } else {
                document.body.innerHTML = '<div style="text-align:center; margin-top:50px;">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
            }
        };

        function renderFromUrl(base64url) {
            try {
                // 1. URL Safe Base64 -> Standard Base64
                let str = base64url.replace(/-/g, '+').replace(/_/g, '/');
                while (str.length % 4) str += '=';

                // 2. Decode Base64 to Binary String -> Uint8Array
                const binary = atob(str);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }

                // 3. Parse Binary Data
                let ptr = 0;
                const decoder = new TextDecoder();

                // Check Version
                let isV1 = false;
                if (bytes.length > 0 && bytes[0] === 0xFF) {
                    // Header found
                    if (bytes.length > 1 && bytes[1] === 0x01) {
                        isV1 = true;
                        ptr += 2; // Skip FF 01
                    } else {
                        // Unknown version or just FF? Treat as legacy if possible, but FF is not a valid boss ID (0-17).
                        // If bytes[0] is FF, it's definitely not a boss ID.
                        throw new Error("Unknown data version");
                    }
                }

                // A. Bosses (3 bytes)
                if (bytes.length < ptr + 3) throw new Error("Data too short");

                const b1 = bytes[ptr++];
                const b2 = bytes[ptr++];
                const b3 = bytes[ptr++];

                // ãƒœã‚¹åã¨å¼±ç‚¹ã‚’è¡¨ç¤º
                const getBossLabel = (idx) => {
                    const d = BOSS_DATA[idx];
                    return d ? `${d.name} (${d.weak})` : "-";
                };

                document.getElementById('boss-1').textContent = getBossLabel(b1);
                document.getElementById('boss-2').textContent = getBossLabel(b2);
                document.getElementById('boss-3').textContent = getBossLabel(b3);

                // B. Rows (Members)
                const grid = document.getElementById('battle-grid');

                // 6è¡Œåˆ†ãƒ«ãƒ¼ãƒ—
                for (let i = 0; i < 6; i++) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒå°½ããŸã‚‰çµ‚äº†
                    if (ptr >= bytes.length) break;

                    const div = document.createElement('div');
                    div.className = 'grid-row';

                    // -- Name Length (1 byte) --
                    const nameLen = bytes[ptr++];

                    // -- Name Bytes --
                    const nameBytes = bytes.slice(ptr, ptr + nameLen);
                    ptr += nameLen;
                    const name = decoder.decode(nameBytes);

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'p-name-box';
                    nameDiv.textContent = name || "-";
                    div.appendChild(nameDiv);

                    // -- Jobs (3 bytes) --
                    for (let j = 0; j < 3; j++) {
                        let val = 255;
                        if (ptr < bytes.length) val = bytes[ptr++];

                        const slot = document.createElement('div');
                        slot.className = 'job-slot';

                        let jIdx = val;
                        let isMaster = false;
                        let isLv99 = false;

                        if (isV1) {
                            isMaster = (val & 0x80) !== 0;
                            isLv99 = (val & 0x40) !== 0;
                            jIdx = val & 0x3F;
                        }

                        // 255 (or 63 in V1) is empty
                        // Check if jIdx is valid
                        if (jIdx < JOBS.length) {
                            slot.classList.add('has-job');
                            slot.textContent = JOBS[jIdx];

                            if (isMaster) {
                                slot.classList.add('target-master');
                                slot.innerHTML += '<span class="slot-mark-master">â˜…</span>';
                            } else if (isLv99) {
                                slot.classList.add('target-lv99');
                            }
                        }
                        div.appendChild(slot);
                    }
                    grid.appendChild(div);
                }

            } catch (e) {
                console.error(e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nURLãŒæ­£ã—ããªã„ã‹ã€å½¢å¼ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚");
            }
        }
    </script>
</body>

</html>