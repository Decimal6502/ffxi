<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gaol Tactician (Viewer)</title>
    <style>
        :root { --bg: #f4f4f9; --border: #ddd; }
        body { font-family: sans-serif; margin: 0; padding: 20px 10px; background: var(--bg); }
        .alert-box { background: #e2e6ea; padding: 10px; text-align: center; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; border:1px solid #ccc; }
        .boss-header { display: grid; grid-template-columns: 100px 1fr 1fr 1fr; gap: 4px; margin-bottom: 5px; text-align: center; font-size: 0.85em; font-weight: bold; color: #555;}
        .boss-name { background: #fff; border: 1px solid #999; border-radius: 4px; padding: 5px; }
        .grid-row { display: grid; grid-template-columns: 100px 1fr 1fr 1fr; gap: 4px; margin-bottom: 6px; min-height: 50px; }
        .p-name-box { display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border); padding: 5px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; word-break: break-all; }
        .job-slot { background: white; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; }
        .job-slot.has-job { background-color: #fff; border: 2px solid #555; color: #333; }
        @media (max-width: 400px) { .grid-row, .boss-header { grid-template-columns: 80px 1fr 1fr 1fr; } .job-slot { font-size: 0.9rem; } }
    </style>
</head>
<body>

    <div class="alert-box">
        ğŸ“ å…±æœ‰ã•ã‚ŒãŸä½œæˆ¦ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ (é–²è¦§å°‚ç”¨)
    </div>

    <div class="boss-header">
        <div>MEMBER</div>
        <div class="boss-name" id="boss-1">-</div>
        <div class="boss-name" id="boss-2">-</div>
        <div class="boss-name" id="boss-3">-</div>
    </div>

    <div id="battle-grid"></div>

<script>
    const JOBS = ['æˆ¦','ãƒ¢','ç™½','é»’','èµ¤','ã‚·','ãƒŠ','æš—','ç£','è©©','ç‹©','ä¾','å¿','ç«œ','å¬','é’','ã‚³','ã‹','è¸Š','å­¦','é¢¨','å‰£'];
    
    // â–¼ åå‰ã ã‘ã®ãƒªã‚¹ãƒˆã§ã¯ãªãã€å¼±ç‚¹æƒ…å ±ã‚’å«ã‚€ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã—ã¾ã™
    const BOSS_DATA = [
        {name:"Ongo",weak:"åœŸ/é­”"},{name:"Xevioso",weak:"çª/ã‚¯ãƒª"},{name:"Arebati",weak:"çª/é "},
        {name:"Ngai",weak:"æ‰“"},{name:"Kalunga",weak:"æ–¬"},{name:"Mboze",weak:"æ–¬"},
        {name:"Bumba",weak:"é­”/ç‰¹"},{name:"Gogmagog",weak:"æ‰“"},{name:"Aristaeus",weak:"æ–¬"},
        {name:"Raskovniche",weak:"é¢¨/é­”"},{name:"Marmorkrebs",weak:"é›·/é­”"},{name:"Gigelorum",weak:"æ‰“"},
        {name:"Procne",weak:"çª"},{name:"Henwen",weak:"æ‰“"},{name:"Sgili",weak:"ç«/é­”"},
        {name:"U Bnai",weak:"ç«/é­”"},{name:"Dealan-dhe",weak:"çª"},{name:"---",weak:""}
    ];

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const sharedData = params.get('s');
        if (sharedData) {
            renderFromUrl(sharedData);
        } else {
            document.body.innerHTML = '<div style="text-align:center; margin-top:50px;">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
        }
    };

    function renderFromUrl(base64url) {
        try {
            // URL Safe Base64 -> Standard Base64
            let str = base64url.replace(/-/g, '+').replace(/_/g, '/');
            while (str.length % 4) str += '=';
            
            // Base64 -> Binary String -> Uint8Array
            const binary = atob(str);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            
            let offset = 0;
            const decoder = new TextDecoder();

            // 1. Bosses (æœ€åˆã®3ãƒã‚¤ãƒˆ)
            const b1Idx = bytes[offset++] || 0;
            const b2Idx = bytes[offset++] || 0;
            const b3Idx = bytes[offset++] || 0;

            // â–¼ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã€åå‰ã¨å¼±ç‚¹ã‚’ã‚»ãƒƒãƒˆã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const getBossLabel = (idx) => {
                const data = BOSS_DATA[idx];
                if (!data || data.name === "---") return "-";
                return `${data.name} (${data.weak})`;
            };

            document.getElementById('boss-1').textContent = getBossLabel(b1Idx);
            document.getElementById('boss-2').textContent = getBossLabel(b2Idx);
            document.getElementById('boss-3').textContent = getBossLabel(b3Idx);

            // 2. Grid (6è¡Œåˆ†ã®èª­ã¿å‡ºã—)
            const grid = document.getElementById('battle-grid');
            grid.innerHTML = ''; // ã‚¯ãƒªã‚¢

            for(let i=0; i<6; i++) {
                if(offset >= bytes.length) break;

                // åå‰: é•·ã•(1byte) + æ–‡å­—åˆ—
                const nameLen = bytes[offset++];
                let name = "";
                if(nameLen > 0) {
                    name = decoder.decode(bytes.slice(offset, offset + nameLen));
                    offset += nameLen;
                }

                // ã‚¸ãƒ§ãƒ–: 3ãƒã‚¤ãƒˆ
                const jobs = [];
                for(let j=0; j<3; j++) {
                    const jIdx = bytes[offset++];
                    const jobName = (jIdx !== undefined && jIdx !== 255) ? JOBS[jIdx] : null;
                    jobs.push(jobName);
                }

                // æç”»
                const div = document.createElement('div');
                div.className = 'grid-row';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'p-name-box';
                nameDiv.textContent = name || "-";
                div.appendChild(nameDiv);

                jobs.forEach(job => {
                    const slot = document.createElement('div');
                    slot.className = 'job-slot';
                    if(job) {
                        slot.classList.add('has-job');
                        slot.textContent = job;
                    }
                    div.appendChild(slot);
                });
                grid.appendChild(div);
            }

        } catch(e) {
            console.error(e);
            alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nURLãŒæ­£ã—ããªã„ã‹ã€å½¢å¼ãŒå¤ã„ã§ã™ã€‚");
        }
    }
</script>
</body>
</html>
