<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gaol Tactician (Editor)</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --info: #17a2b8; --danger: #dc3545; --bg: #f4f4f9; --border: #ddd; --master-bg: #fff3cd; --master-border: #ffc107; --lv99-bg: #e2e6ea; --lv99-border: #adb5bd; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); touch-action: manipulation; padding-bottom: 250px; }
        .tabs { display: flex; background: #333; color: white; position: sticky; top: 0; z-index: 1000; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 4px solid transparent; font-size: 0.9rem;}
        .tab.active { border-bottom: 4px solid var(--primary); font-weight: bold; background: #444; }
        .content { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .content.active { display: block; }
        .btn-action { padding: 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; color: white; text-align: center;}
        .btn-add { background: var(--success); width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-auto { background: var(--info); width: 100%; margin-bottom: 15px; font-size: 1rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-copy { background: #6c757d; width: 80px; margin-left: 5px;}
        .del-row { background: var(--danger); height: 100%; padding: 0 15px; }
        .member-row { background: white; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid var(--border); display: grid; grid-template-columns: 120px 1fr 40px; gap: 8px; align-items: center; }
        .inputs-col { display: flex; flex-direction: column; gap: 5px; }
        .member-row input { padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; width: 100%; box-sizing: border-box;}
        .job-label { font-size: 0.7rem; color: #666; margin-bottom: 1px; }
        .boss-header { display: grid; grid-template-columns: 135px 1fr 1fr 1fr; gap: 4px; margin-bottom: 5px; text-align: center; font-size: 0.85em; position: sticky; top: 48px; background: var(--bg); z-index: 900; padding: 5px 0; }
        .boss-select { width: 100%; padding: 4px; font-size: 0.8rem; border: 1px solid #999; border-radius: 4px;}
        .grid-row { display: grid; grid-template-columns: 135px 1fr 1fr 1fr; gap: 4px; margin-bottom: 6px; min-height: 60px; }
        .player-col { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
        .player-select { width: 100%; padding: 4px; font-size: 0.85rem; background: white; border: 1px solid var(--border); height: 30px;}
        .player-jobs-preview { font-size: 0.75rem; color: #444; background: #e9ecef; padding: 3px 5px; border-radius: 3px; line-height: 1.3; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; overflow: hidden; height: auto; min-height: 2.6em; }
        .job-star { font-weight: bold; color: #d39e00; } .job-norm { color: #555; font-size: 0.95em; }
        .job-slot { background: white; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; cursor: pointer; position: relative; transition: background 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .job-slot.disabled { background-color: #f8f9fa; border-color: #eee; cursor: not-allowed; opacity: 0.6; }
        .job-slot.target-master { background-color: var(--master-bg); border: 2px solid var(--master-border); animation: pulse-gold 1.5s infinite; }
        .job-slot.target-lv99 { background-color: var(--lv99-bg); border: 2px solid var(--lv99-border); }
        .job-slot.has-job { background-color: #fff; border: 2px solid #555; color: #333; }
        .slot-mark-master { position: absolute; top: 0; right: 2px; color: #ffc107; font-size: 0.7rem; }
        .share-area { margin-top: 30px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #ccc; }
        .share-input-group { display: flex; gap: 5px; margin-top: 5px; }
        .share-url-box { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; color: #555; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .deck-container { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 2px solid #ccc; padding: 8px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2000; }
        .deck-info { font-size: 0.8rem; color: #007bff; margin-bottom: 5px; text-align: center; font-weight: bold; height: 1.2em;}
        .deck-grid { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
        .job-chip { padding: 8px 10px; background: #fff; border: 1px solid #999; border-radius: 4px; font-size: 0.9rem; cursor: pointer; user-select: none; font-weight: bold; }
        .job-chip.selected { background: var(--primary); color: white; transform: translateY(-2px); border-color: var(--primary); }
        .job-chip.used { background: #666; color: #ccc; border-color: #444; opacity: 0.5; }
        @media (max-width: 400px) { .grid-row, .boss-header { grid-template-columns: 110px 1fr 1fr 1fr; } .member-row { grid-template-columns: 100px 1fr 40px; } .job-slot { font-size: 1.0rem; } .job-chip { padding: 6px 8px; font-size: 0.8rem; } }
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('board')">‰ΩúÊà¶„Éú„Éº„Éâ</div>
        <div class="tab" onclick="switchTab('settings')">„É°„É≥„Éê„ÉºË®≠ÂÆö</div>
    </div>

    <div id="settings" class="content">
        <h3>„É°„É≥„Éê„ÉºÁôªÈå≤</h3>
        <div id="settings-list"></div>
        <button class="btn-action btn-add" onclick="addMemberRow()">Ôºã „É°„É≥„Éê„Éº„ÇíËøΩÂä†</button>
    </div>

    <div id="board" class="content active">
        <button class="btn-action btn-auto" onclick="autoFillBoard()">üé≤ ÊÆã„Çä„ÇíÈÅ©ÂΩì„Å´Âüã„ÇÅ„Çã</button>

        <div class="boss-header">
            <div style="padding-top:5px; font-weight:bold; color:#666;">MEMBER</div>
            <select class="boss-select" id="boss-1" onchange="saveBoardState()"></select>
            <select class="boss-select" id="boss-2" onchange="saveBoardState()"></select>
            <select class="boss-select" id="boss-3" onchange="saveBoardState()"></select>
        </div>
        <div id="battle-grid"></div>

        <div class="share-area">
            <h4 style="margin:0 0 5px 0;">ÂÖ±ÊúâÁî®URLÁô∫Ë°å</h4>
            <div style="font-size:0.8rem; color:#666;">Èñ≤Ë¶ßÂ∞ÇÁî®„Éö„Éº„Ç∏(viewer.html)„ÅÆ„É™„É≥„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ</div>
            <div class="share-input-group">
                <input type="text" id="share-url" class="share-url-box" readonly onclick="this.select()">
                <button class="btn-action btn-copy" onclick="copyShareUrl()">„Ç≥„Éî„Éº</button>
            </div>
            <button class="btn-action" style="background:#007bff; margin-top:10px; width:100%;" onclick="generateShareUrl()">URL„ÇíÁô∫Ë°å/Êõ¥Êñ∞</button>
        </div>
        <div style="height: 50px;"></div>
    </div>

    <div class="deck-container">
        <div class="deck-info" id="deck-message">„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <div class="deck-grid" id="deck-grid"></div>
    </div>

<script>
    const JOBS = ['Êà¶','„É¢','ÁôΩ','Èªí','Ëµ§','„Ç∑','„Éä','Êöó','Áç£','Âêü','Áã©','‰æç','Âøç','Á´ú','Âè¨','Èùí','„Ç≥','„Åã','Ë∏ä','Â≠¶','È¢®','Ââ£'];
    const JOB_FULLNAMES = {'Êà¶':'Êà¶Â£´','„É¢':'„É¢„É≥„ÇØ','ÁôΩ':'ÁôΩÈ≠î','Èªí':'ÈªíÈ≠î','Ëµ§':'Ëµ§È≠î','„Ç∑':'„Ç∑„Éº„Éï','„Éä':'„Éä„Ç§„Éà','Êöó':'ÊöóÈªí','Áç£':'Áç£‰Ωø','Âêü':'ÂêüÈÅä','Áã©':'Áã©‰∫∫','‰æç':'‰æç','Âøç':'ÂøçËÄÖ','Á´ú':'Á´úÈ®é','Âè¨':'Âè¨Âñö','Èùí':'ÈùíÈ≠î','„Ç≥':'„Ç≥„É´','„Åã':'„Åã„Çâ','Ë∏ä':'Ë∏ä„Çä','Â≠¶':'Â≠¶ËÄÖ','È¢®':'È¢®Ê∞¥','Ââ£':'Ââ£'};
    const BOSS_DATA = [{name:"Ongo",weak:"Âúü/È≠î"},{name:"Xevioso",weak:"Á™Å/„ÇØ„É™"},{name:"Arebati",weak:"Á™Å/ÈÅ†"},{name:"Ngai",weak:"Êâì"},{name:"Kalunga",weak:"Êñ¨"},{name:"Mboze",weak:"Êñ¨"},{name:"Bumba",weak:"È≠î/Áâπ"},{name:"Gogmagog",weak:"Êâì"},{name:"Aristaeus",weak:"Êñ¨"},{name:"Raskovniche",weak:"È¢®/È≠î"},{name:"Marmorkrebs",weak:"Èõ∑/È≠î"},{name:"Gigelorum",weak:"Êâì"},{name:"Procne",weak:"Á™Å"},{name:"Henwen",weak:"Êâì"},{name:"Sgili",weak:"ÁÅ´/È≠î"},{name:"U Bnai",weak:"ÁÅ´/È≠î"},{name:"Dealan-dhe",weak:"Á™Å"},{name:"---",weak:""}];

    let members = []; 
    const KEY_MEMBERS = 'gt_members_v2';
    const KEY_BOARD = 'gt_board_state';
    let boardState = Array(6).fill(null).map(() => [null, null, null]);
    let selectedPlayerIndices = [-1, -1, -1, -1, -1, -1];
    let selectedJob = null; 

    window.onload = function() {
        loadSettings();
        loadBoardState();
        initBoardUI();
        // renderDeck(); <- ÂâäÈô§: usedJobs„ÅåÊú™ÂÆöÁæ©„Åß„Ç®„É©„Éº„Å´„Å™„Çã„ÅÆ„Å®„ÄÅswitchTab„ÅßÂÜçÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅ‰∏çË¶Å
        switchTab('board');
    };

    function switchTab(tabName) {
        if(document.getElementById('settings').classList.contains('active')) saveSettingsFromDOM(); 
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        if(tabName === 'settings') {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('settings').classList.add('active');
            renderSettingsList();
        } else {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('board').classList.add('active');
            refreshBoard();
        }
    }

    function loadSettings() { const json = localStorage.getItem(KEY_MEMBERS); members = json ? JSON.parse(json) : []; }
    function loadBoardState() {
        const json = localStorage.getItem(KEY_BOARD);
        if (json) {
            const state = JSON.parse(json);
            if(state.board) boardState = state.board;
            if(state.players) selectedPlayerIndices = state.players;
            if(state.bosses) {
                setTimeout(() => { const b1 = document.getElementById('boss-1'); if(b1) { b1.value = state.bosses[0]; document.getElementById('boss-2').value = state.bosses[1]; document.getElementById('boss-3').value = state.bosses[2]; } }, 0);
            }
        }
    }
    function saveBoardState() {
        const boss1 = document.getElementById('boss-1')?.value || "Ongo";
        const boss2 = document.getElementById('boss-2')?.value || "Kalunga";
        const boss3 = document.getElementById('boss-3')?.value || "Mboze";
        localStorage.setItem(KEY_BOARD, JSON.stringify({ board: boardState, players: selectedPlayerIndices, bosses: [boss1, boss2, boss3] }));
    }

    function parseJobString(str) { if(!str) return []; if(str.includes('ÂÖ®')) return [...JOBS]; return JOBS.filter(j => str.includes(j)); }
    function saveSettingsFromDOM() {
        const rows = document.getElementById('settings-list').children;
        if (rows.length === 0 && members.length > 0) return;
        const newMembers = [];
        for(let i=0; i<rows.length; i++) {
            const name = document.getElementById(`name-${i}`).value;
            const masterStr = document.getElementById(`master-${i}`).value;
            const lv99Str = document.getElementById(`lv99-${i}`).value;
            if (name || masterStr || lv99Str) {
                const mJobs = parseJobString(masterStr);
                let lJobs = parseJobString(lv99Str);
                lJobs = lJobs.filter(j => !mJobs.includes(j));
                newMembers.push({ name: name, masterStr: masterStr, lv99Str: lv99Str, masterJobs: mJobs, lv99Jobs: lJobs });
            }
        }
        members = newMembers;
        localStorage.setItem(KEY_MEMBERS, JSON.stringify(members));
    }
    function renderSettingsList() {
        const container = document.getElementById('settings-list'); container.innerHTML = '';
        members.forEach((m, idx) => {
            const div = document.createElement('div'); div.className = 'member-row';
            div.innerHTML = `<div><input type="text" value="${m.name}" id="name-${idx}" placeholder="ÂêçÂâç" onchange="saveSettingsFromDOM()"></div><div class="inputs-col"><div><div class="job-label">‚òÖ„Éû„Çπ„Çø„Éº</div><input type="text" value="${m.masterStr || ''}" id="master-${idx}" placeholder="‰æã: Êà¶„É¢ÁôΩ" onchange="saveSettingsFromDOM()"></div><div><div class="job-label">Lv99</div><input type="text" value="${m.lv99Str || ''}" id="lv99-${idx}" placeholder="‰æã: „Ç∑Âêü" onchange="saveSettingsFromDOM()"></div></div><button class="btn-action del-row" onclick="deleteMember(${idx})">√ó</button>`;
            container.appendChild(div);
        });
    }
    function addMemberRow() { saveSettingsFromDOM(); members.push({name: "", masterStr: "", lv99Str: "", masterJobs: [], lv99Jobs: []}); renderSettingsList(); saveSettingsFromDOM(); }
    function deleteMember(targetIdx) {
        if(!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
        saveSettingsFromDOM(); members.splice(targetIdx, 1); localStorage.setItem(KEY_MEMBERS, JSON.stringify(members));
        for(let r=0; r<6; r++) { const currentP = selectedPlayerIndices[r]; if (currentP === targetIdx) { selectedPlayerIndices[r] = -1; boardState[r] = [null, null, null]; } else if (currentP > targetIdx) { selectedPlayerIndices[r] = currentP - 1; } }
        saveBoardState(); renderSettingsList();
    }

    function initBoardUI() {
        const selects = document.querySelectorAll('.boss-select');
        selects.forEach((sel, i) => { sel.innerHTML = BOSS_DATA.map(b => `<option value="${b.name}">${b.name} (${b.weak})</option>`).join(''); if(i===0) sel.value = "Ongo"; if(i===1) sel.value = "Kalunga"; if(i===2) sel.value = "Mboze"; });
        const grid = document.getElementById('battle-grid'); grid.innerHTML = '';
        for(let r=0; r<6; r++) {
            const rowDiv = document.createElement('div'); rowDiv.className = 'grid-row';
            const pCol = document.createElement('div'); pCol.className = 'player-col';
            const pSel = document.createElement('select'); pSel.className = 'player-select';
            pSel.onchange = (e) => { selectedPlayerIndices[r] = parseInt(e.target.value); validateRowJobs(r); saveBoardState(); refreshBoard(); };
            pCol.appendChild(pSel);
            const pJobs = document.createElement('div'); pJobs.className = 'player-jobs-preview'; pJobs.id = `player-jobs-${r}`; pCol.appendChild(pJobs);
            rowDiv.appendChild(pCol);
            for(let c=0; c<3; c++) {
                const slot = document.createElement('div'); slot.className = 'job-slot'; slot.id = `slot-${r}-${c}`;
                slot.onclick = () => handleSlotClick(r, c); slot.ondragover = (e) => e.preventDefault();
                slot.ondrop = (e) => { e.preventDefault(); setJob(r, c, e.dataTransfer.getData("text")); };
                rowDiv.appendChild(slot);
            }
            grid.appendChild(rowDiv);
        }
    }
    function refreshBoard() {
        const selects = document.querySelectorAll('.player-select');
        selects.forEach((sel, r) => {
            if (selectedPlayerIndices[r] >= members.length) selectedPlayerIndices[r] = -1;
            const currentVal = selectedPlayerIndices[r];
            let html = `<option value="-1" ${currentVal === -1 ? 'selected' : ''}>-- ÈÅ∏Êäû --</option>`;
            members.forEach((m, idx) => {
                const isSelectedElsewhere = selectedPlayerIndices.some((val, rowIdx) => rowIdx !== r && val === idx);
                const disabledAttr = isSelectedElsewhere ? 'disabled style="color:#ccc"' : '';
                const nameLabel = m.name + (isSelectedElsewhere ? ' (ÈÅ∏ÊäûÊ∏à)' : '');
                html += `<option value="${idx}" ${idx === currentVal ? 'selected' : ''} ${disabledAttr}>${nameLabel}</option>`;
            });
            sel.innerHTML = html; sel.value = currentVal; 
            const previewDiv = document.getElementById(`player-jobs-${r}`);
            if (currentVal !== -1 && members[currentVal]) {
                const mJobs = members[currentVal].masterJobs.map(j => `<span class="job-star">${j}</span>`).join(' ');
                const nJobs = members[currentVal].lv99Jobs.map(j => `<span class="job-norm">${j}</span>`).join(' ');
                previewDiv.innerHTML = (members[currentVal].masterStr.includes('ÂÖ®')) ? '<span class="job-star">ÂÖ®„Éû„Çπ„Çø„Éº</span>' : (members[currentVal].lv99Str.includes('ÂÖ®') ? '<span class="job-norm">ÂÖ®Lv99</span>' : (mJobs + ' ' + nJobs).trim());
            } else { previewDiv.textContent = ""; }
        });
        const usedJobs = new Set(); boardState.forEach(row => row.forEach(j => { if(j) usedJobs.add(j); }));
        for(let r=0; r<6; r++) {
            const pIdx = selectedPlayerIndices[r]; const player = (pIdx !== -1) ? members[pIdx] : null;
            for(let c=0; c<3; c++) {
                const slot = document.getElementById(`slot-${r}-${c}`); const currentJob = boardState[r][c];
                slot.innerHTML = currentJob || ""; slot.className = 'job-slot'; 
                if (currentJob) { slot.classList.add('has-job'); if(player && player.masterJobs.includes(currentJob)) slot.innerHTML += '<span class="slot-mark-master">‚òÖ</span>'; }
                if (!player) { slot.classList.add('disabled'); continue; }
                if (selectedJob) {
                    const isGlobalUsed = usedJobs.has(selectedJob) && currentJob !== selectedJob;
                    const isMaster = player.masterJobs.includes(selectedJob); const isLv99 = player.lv99Jobs.includes(selectedJob);
                    if ((!isMaster && !isLv99) || isGlobalUsed) slot.classList.add('disabled');
                    else { if(isMaster) slot.classList.add('target-master'); else if(isLv99) slot.classList.add('target-lv99'); }
                }
            }
        }
        renderDeck(usedJobs);
    }
    // Set default value for usedJobs to handle calls without arguments
    function renderDeck(usedJobs = new Set()) {
        const container = document.getElementById('deck-grid'); container.innerHTML = ''; const msg = document.getElementById('deck-message');
        if (!selectedJob) { msg.textContent = "„Ç∏„Éß„Éñ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"; msg.style.color = "#007bff"; } else { msg.textContent = `„Äå${JOB_FULLNAMES[selectedJob]}„Äç„ÇíÈÅ∏Êäû‰∏≠...`; msg.style.color = "#d9534f"; }
        JOBS.forEach(job => {
            const btn = document.createElement('div'); btn.className = 'job-chip';
            if (usedJobs.has(job)) btn.classList.add('used'); if (selectedJob === job) btn.classList.add('selected');
            btn.textContent = JOB_FULLNAMES[job];
            btn.onclick = () => { if(usedJobs.has(job)) return; selectedJob = (selectedJob === job) ? null : job; refreshBoard(); };
            btn.draggable = true; btn.ondragstart = (e) => { if(usedJobs.has(job)) { e.preventDefault(); return; } e.dataTransfer.setData("text", job); selectedJob = job; refreshBoard(); };
            container.appendChild(btn);
        });
    }
    function handleSlotClick(r, c) { if (selectedPlayerIndices[r] === -1) return; if (selectedJob) setJob(r, c, selectedJob); else if (boardState[r][c]) setJob(r, c, null); }
    function setJob(r, c, job) {
        const pIdx = selectedPlayerIndices[r]; if (pIdx === -1) return; const player = members[pIdx];
        if (!job) { boardState[r][c] = null; selectedJob = null; saveBoardState(); refreshBoard(); return; }
        const isMaster = player.masterJobs.includes(job); const isLv99 = player.lv99Jobs.includes(job);
        if (!isMaster && !isLv99) return; 
        const isUsed = boardState.some((row, rr) => row.some((j, cc) => j === job && !(rr === r && cc === c)));
        if (isUsed) { alert(`${job} „ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`); return; }
        boardState[r][c] = job; selectedJob = null; saveBoardState(); refreshBoard();
    }
    function validateRowJobs(r) {
        const pIdx = selectedPlayerIndices[r]; if(pIdx === -1) { boardState[r] = [null, null, null]; return; }
        const player = members[pIdx]; if(!player) return;
        for(let c=0; c<3; c++) { const job = boardState[r][c]; if(job && !player.masterJobs.includes(job) && !player.lv99Jobs.includes(job)) boardState[r][c] = null; }
    }
    function autoFillBoard() {
        if(!confirm("Á©∫„ÅÑ„Å¶„ÅÑ„ÇãÊû†„ÇíËá™Âãï„ÅßÂüã„ÇÅ„Åæ„Åô„ÅãÔºü")) return;

        // 1. ÁèæÂú®„ÄÅÁõ§Èù¢„Åß‰ΩøÁî®Ê∏à„Åø„ÅÆ„Ç∏„Éß„Éñ„ÇíÁâπÂÆö
        const usedJobs = new Set();
        boardState.forEach(row => row.forEach(j => { if(j) usedJobs.add(j); }));

        // 2. Á©∫„ÅÑ„Å¶„ÅÑ„Çã„Çπ„É≠„ÉÉ„Éà„ÇíÂÖ®„Å¶„É™„Çπ„Éà„Ç¢„ÉÉ„Éó
        let emptySlots = [];
        for(let r=0; r<6; r++) {
            if(selectedPlayerIndices[r] === -1) continue; // „Éó„É¨„Ç§„É§„ÉºÊú™ÈÅ∏Êäû„ÅÆË°å„ÅØÁÑ°Ë¶ñ
            for(let c=0; c<3; c++) {
                if(!boardState[r][c]) emptySlots.push({r, c});
            }
        }

        // 3. ÂÖ®„Å¶„ÅÆÁ©∫„Åç„Çπ„É≠„ÉÉ„Éà„ÅåÂüã„Åæ„Çã„Åã„ÄÅÂÄôË£ú„Åå„Å™„Åè„Å™„Çã„Åæ„Åß„É´„Éº„Éó
        while(emptySlots.length > 0) {
            
            // ÂêÑ„Çπ„É≠„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶„ÄÅ„ÄåÁèæÊôÇÁÇπ„ÅßÈÅ∏ÊäûÂèØËÉΩ„Å™„Ç∏„Éß„Éñ„Äç„ÇíË®àÁÆó
            const slotsWithCandidates = emptySlots.map(slot => {
                const player = members[selectedPlayerIndices[slot.r]];
                
                // „Éû„Çπ„Çø„Éº„Å®Lv99„ÅÆ‰∏°Êñπ„Åã„Çâ„ÄÅ„Åæ„Å†‰Ωø„Çè„Çå„Å¶„ÅÑ„Å™„ÅÑ(usedJobs„Å´„Å™„ÅÑ)„ÇÇ„ÅÆ„ÇíÊäΩÂá∫
                const validMaster = player.masterJobs.filter(j => !usedJobs.has(j));
                const validLv99 = player.lv99Jobs.filter(j => !usedJobs.has(j));
                
                // ÂÄôË£ú„ÅÆÁ∑èÊï∞ÔºàÂÑ™ÂÖàÂ∫¶Âà§ÂÆöÁî®Ôºâ„Å®„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÂÄôË£ú„É™„Çπ„Éà
                const totalCount = validMaster.length + validLv99.length;
                
                return { 
                    ...slot, 
                    validMaster, 
                    validLv99, 
                    totalCount 
                };
            });

            // ÂÄôË£ú„ÅåÂ∞ë„Å™„ÅÑÈ†Ü„Å´‰∏¶„ÅπÊõø„ÅàÔºàÊòáÈ†ÜÔºâ
            // „Åì„Çå„Å´„Çà„Çä„Äå„ÅÇ„Å®1„Å§„Åó„ÅãÈÅ∏„Åπ„Å™„ÅÑÔºÅ„Äç„Å®„ÅÑ„ÅÜ‰∫∫„ÅåÂÖàÈ†≠„Å´Êù•„Åæ„Åô
            slotsWithCandidates.sort((a, b) => a.totalCount - b.totalCount);

            // ÊúÄ„ÇÇÂàáÁæΩË©∞„Åæ„Å£„Å¶„ÅÑ„Çã„Çπ„É≠„ÉÉ„Éà„ÇíÂèñÂæó
            const target = slotsWithCandidates[0];

            if (target.totalCount === 0) {
                // ÂÄôË£ú„Åå0ÂÄã„Å™„Çâ„ÄÅ„ÇÇ„ÅÜÂüã„ÇÅ„Çâ„Çå„Å™„ÅÑ„ÅÆ„Åß„É™„Çπ„Éà„Åã„ÇâÂ§ñ„Åó„Å¶Ê¨°„Å∏ÔºàÊâãË©∞„Åæ„ÇäÂõûÈÅøÔºâ
                emptySlots = emptySlots.filter(s => !(s.r === target.r && s.c === target.c));
                continue;
            }

            // ÂÄôË£ú„ÅÆ‰∏≠„Åã„Çâ„Ç∏„Éß„Éñ„ÇíÊ±∫ÂÆöÔºà„Éû„Çπ„Çø„ÉºÂÑ™ÂÖà„ÄÅ„Åù„ÅÆ‰∏≠„Åß„É©„É≥„ÉÄ„É†Ôºâ
            let pick = null;
            if (target.validMaster.length > 0) {
                pick = target.validMaster[Math.floor(Math.random() * target.validMaster.length)];
            } else {
                pick = target.validLv99[Math.floor(Math.random() * target.validLv99.length)];
            }

            // Ê±∫ÂÆö„Åó„Åü„Ç∏„Éß„Éñ„ÇíÁõ§Èù¢„Å´„Çª„ÉÉ„Éà„Åó„ÄÅ‰ΩøÁî®Ê∏à„Åø„É™„Çπ„Éà„Å´ËøΩÂä†
            boardState[target.r][target.c] = pick;
            usedJobs.add(pick);

            // Âüã„ÇÅ„Åü„Çπ„É≠„ÉÉ„Éà„Çí„É™„Çπ„Éà„Åã„ÇâÈô§Â§ñ
            emptySlots = emptySlots.filter(s => !(s.r === target.r && s.c === target.c));
        }

        saveBoardState();
        refreshBoard();
    }

    // --- Modern URL Encoding Logic (Standard & URL Safe) ---
// --- index.html ÂÜÖ ---

    function generateShareUrl() {
        const boss1 = document.getElementById('boss-1')?.value;
        const boss2 = document.getElementById('boss-2')?.value;
        const boss3 = document.getElementById('boss-3')?.value;

        // „Éê„Ç§„Éä„É™„Éá„Éº„Çø„ÇíÊ†ºÁ¥ç„Åô„ÇãÈÖçÂàó
        const bytes = [];

        // 1. „Éú„ÇπÊÉÖÂ†±„ÅÆÊ†ºÁ¥ç („Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ: 1byte x 3)
        [boss1, boss2, boss3].forEach(b => {
             const idx = BOSS_DATA.findIndex(d => d.name === b);
             bytes.push(idx >= 0 ? idx : 0); // Ë¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞0
        });

        const encoder = new TextEncoder();

        // 2. „É°„É≥„Éê„ÉºÊÉÖÂ†± (6‰∫∫ÂàÜÂõ∫ÂÆö)
        for(let r=0; r<6; r++) {
            const pIdx = selectedPlayerIndices[r];
            const player = (pIdx !== -1) ? members[pIdx] : null;
            
            // A. ÂêçÂâç: Èï∑„Åï(1byte) + UTF-8„Éê„Ç§„ÉàÂàó
            const name = player ? player.name : "";
            const nameBytes = encoder.encode(name);
            // ‚ÄªÂêçÂâç„ÅåÈï∑„Åô„Åé„Çã(255byteË∂Ö)Â†¥Âêà„ÅØ„Ç´„ÉÉ„Éà„Åô„Çã„Å™„Å©„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å„Åß„Åô„Åå„ÄÅÈÄöÂ∏∏ÈÅãÁî®„Å™„Çâ„Åì„ÅÆ„Åæ„Åæ„ÅßOK
            bytes.push(nameBytes.length); 
            nameBytes.forEach(b => bytes.push(b));

            // B. „Ç∏„Éß„Éñ: „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ (1byte x 3)
            const rowJobs = boardState[r]; // [J1, J2, J3]
            for(let c=0; c<3; c++) {
                const jobName = rowJobs[c];
                if(jobName) {
                    const jIdx = JOBS.indexOf(jobName);
                    // 255(0xFF)„Çí„ÄåÁ©∫„Äç„Åæ„Åü„ÅØ„Äå‰∏çÊòé„Äç„Å®„Åó„Å¶Êâ±„ÅÑ„Åæ„Åô
                    bytes.push(jIdx >= 0 ? jIdx : 255); 
                } else {
                    bytes.push(255); 
                }
            }
        }

        // Uint8ArrayÂåñ -> „Éê„Ç§„Éä„É™ÊñáÂ≠óÂàó -> Base64 (URL Safe)
        const uint8Arr = new Uint8Array(bytes);
        let binary = '';
        for (let i = 0; i < uint8Arr.length; i++) {
            binary += String.fromCharCode(uint8Arr[i]);
        }
        
        const base64 = btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        const currentPath = window.location.pathname;
        const dir = currentPath.substring(0, currentPath.lastIndexOf('/'));
        const viewerUrl = window.location.protocol + "//" + window.location.host + dir + "/viewer.html?s=" + base64;
        
        document.getElementById('share-url').value = viewerUrl;
    }
    function copyShareUrl() { const copyText = document.getElementById("share-url"); if(!copyText.value) return; copyText.select(); navigator.clipboard.writeText(copyText.value).then(() => { alert("URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ"); }); }
</script>
</body>
</html>
