<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gaol Tactician Zeta</title>
    <style>
        :root {
            --primary: #007bff;
            --master-bg: #fff3cd; --master-border: #ffc107;
            --lv99-bg: #e2e6ea;   --lv99-border: #adb5bd;
            --bg: #f4f4f9; --border: #ddd;
        }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); touch-action: manipulation; padding-bottom: 200px; }
        
        /* タブ */
        .tabs { display: flex; background: #333; color: white; position: sticky; top: 0; z-index: 1000; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 4px solid transparent; font-size: 0.9rem;}
        .tab.active { border-bottom: 4px solid var(--primary); font-weight: bold; background: #444; }
        
        .content { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .content.active { display: block; }
        
        /* 設定画面 */
        .member-row { 
            background: white; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid var(--border);
            display: grid; grid-template-columns: 120px 1fr 40px; gap: 8px; align-items: center;
        }
        .inputs-col { display: flex; flex-direction: column; gap: 5px; }
        .member-row input { padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.9rem; width: 100%; box-sizing: border-box;}
        .job-label { font-size: 0.7rem; color: #666; margin-bottom: 1px; }
        .btn-action { padding: 8px; border-radius: 4px; border: none; cursor: pointer; }
        .btn-add { background: #28a745; color: white; width: 100%; margin-top: 10px; padding: 12px; font-size: 16px; }
        .del-row { background: #dc3545; color: white; height: 100%; }

        /* 作戦ボード */
        .boss-header { 
            display: grid; grid-template-columns: 135px 1fr 1fr 1fr; gap: 4px; 
            margin-bottom: 5px; text-align: center; font-size: 0.85em; 
            position: sticky; top: 48px; background: var(--bg); z-index: 900; padding: 5px 0;
        }
        .boss-select { width: 100%; padding: 4px; font-size: 0.8rem; border: 1px solid #999; border-radius: 4px;}

        .grid-row { display: grid; grid-template-columns: 135px 1fr 1fr 1fr; gap: 4px; margin-bottom: 6px; min-height: 60px; }
        
        .player-col { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
        .player-select { width: 100%; padding: 4px; font-size: 0.85rem; background: white; border: 1px solid var(--border); height: 30px;}
        
        .player-jobs-preview { 
            font-size: 0.75rem; color: #444; background: #e9ecef; 
            padding: 3px 5px; border-radius: 3px; line-height: 1.3;
            display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; overflow: hidden;
            height: auto; min-height: 2.6em; 
        }
        .job-star { font-weight: bold; color: #d39e00; } 
        .job-norm { color: #555; font-size: 0.95em; }

        .job-slot {
            background: white; border: 1px solid #ccc; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; cursor: pointer;
            position: relative; transition: background 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .job-slot.disabled { background-color: #f8f9fa; border-color: #eee; cursor: not-allowed; opacity: 0.6; }
        .job-slot.target-master { background-color: var(--master-bg); border: 2px solid var(--master-border); animation: pulse-gold 1.5s infinite; }
        .job-slot.target-lv99 { background-color: var(--lv99-bg); border: 2px solid var(--lv99-border); }
        .job-slot.has-job { background-color: #fff; border: 2px solid #555; color: #333; }
        .slot-mark-master { position: absolute; top: 0; right: 2px; color: #ffc107; font-size: 0.7rem; }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .deck-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 2px solid #ccc; padding: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2000;
        }
        .deck-info { font-size: 0.8rem; color: #007bff; margin-bottom: 5px; text-align: center; font-weight: bold; height: 1.2em;}
        .deck-grid { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
        
        .job-chip {
            padding: 8px 10px; background: #fff; border: 1px solid #999; border-radius: 4px;
            font-size: 0.9rem; cursor: pointer; user-select: none; font-weight: bold;
        }
        .job-chip.selected { background: var(--primary); color: white; transform: translateY(-2px); border-color: var(--primary); }
        .job-chip.used { background: #666; color: #ccc; border-color: #444; opacity: 0.5; }

        @media (max-width: 400px) {
            .grid-row, .boss-header { grid-template-columns: 110px 1fr 1fr 1fr; }
            .member-row { grid-template-columns: 100px 1fr 40px; }
            .job-slot { font-size: 1.0rem; }
            .job-chip { padding: 6px 8px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('board')">作戦ボード</div>
        <div class="tab" onclick="switchTab('settings')">メンバー設定</div>
    </div>

    <div id="settings" class="content">
        <h3>メンバー登録</h3>
        <p style="font-size:0.8rem; color:#666;">
            ★マスター済みとLv99(その他)を分けて入力できます。<br>
            ※重複した場合はマスターが優先されます。
        </p>
        <div id="settings-list"></div>
        <button class="btn-action btn-add" onclick="addMemberRow()">＋ メンバーを追加</button>
    </div>

    <div id="board" class="content active">
        <div class="boss-header">
            <div style="padding-top:5px; font-weight:bold; color:#666;">MEMBER</div>
            <select class="boss-select" id="boss-1" onchange="saveBoardState()"></select>
            <select class="boss-select" id="boss-2" onchange="saveBoardState()"></select>
            <select class="boss-select" id="boss-3" onchange="saveBoardState()"></select>
        </div>
        <div id="battle-grid"></div>
    </div>

    <div class="deck-container">
        <div class="deck-info" id="deck-message">ジョブを選択してください</div>
        <div class="deck-grid" id="deck-grid"></div>
    </div>

<script>
    // --- データ定数 ---
    const JOBS = ['戦','モ','白','黒','赤','シ','ナ','暗','獣','吟','狩','侍','忍','竜','召','青','コ','か','踊','学','風','剣'];
    const JOB_FULLNAMES = {
        '戦':'戦士','モ':'モンク','白':'白魔','黒':'黒魔','赤':'赤魔','シ':'シーフ',
        'ナ':'ナイト','暗':'暗黒','獣':'獣使','吟':'吟遊','狩':'狩人','侍':'侍',
        '忍':'忍者','竜':'竜騎','召':'召喚','青':'青魔','コ':'コル','か':'から','踊':'踊り','学':'学者','風':'風水','剣':'剣'
    };
    const BOSS_DATA = [
        {name: "Ongo", weak: "土/魔"}, {name: "Xevioso", weak: "突/クリ"}, {name: "Arebati", weak: "突/遠"},
        {name: "Ngai", weak: "打"}, {name: "Kalunga", weak: "斬"}, {name: "Mboze", weak: "斬"},
        {name: "Bumba", weak: "魔/特"}, {name: "Gogmagog", weak: "打"}, {name: "Aristaeus", weak: "斬"},
        {name: "Raskovniche", weak: "風/魔"}, {name: "Marmorkrebs", weak: "雷/魔"}, {name: "Gigelorum", weak: "打"},
        {name: "Procne", weak: "突"}, {name: "Henwen", weak: "打"}, {name: "Sgili", weak: "火/魔"},
        {name: "U Bnai", weak: "火/魔"}, {name: "Dealan-dhe", weak: "突"}, {name: "---", weak: ""}
    ];

    // --- State ---
    let members = []; 
    // State persistence keys
    const KEY_MEMBERS = 'gt_members_v2';
    const KEY_BOARD = 'gt_board_state';

    // 作戦ボードの状態（デフォルト値）
    let boardState = Array(6).fill(null).map(() => [null, null, null]);
    let selectedPlayerIndices = [-1, -1, -1, -1, -1, -1]; // -1 = 未選択
    let selectedJob = null; 

    // --- Init ---
    window.onload = function() {
        loadSettings();
        loadBoardState(); // ボードの状態も復元
        initBoardUI();
        renderDeck();
        switchTab('board');
    };

    function switchTab(tabName) {
        if(document.getElementById('settings').classList.contains('active')) {
            saveSettingsFromDOM(); 
        }

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        
        if(tabName === 'settings') {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('settings').classList.add('active');
            renderSettingsList();
        } else {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('board').classList.add('active');
            refreshBoard();
        }
    }

    // --- Persistence Logic ---

    function loadSettings() {
        const json = localStorage.getItem(KEY_MEMBERS);
        if (json) {
            members = JSON.parse(json);
        } else {
            // デフォルトメンバーなし（空からスタート）
            members = [];
        }
    }

    function loadBoardState() {
        const json = localStorage.getItem(KEY_BOARD);
        if (json) {
            const state = JSON.parse(json);
            if(state.board) boardState = state.board;
            if(state.players) selectedPlayerIndices = state.players;
            
            // ボスの復元
            if(state.bosses) {
                setTimeout(() => { // UI生成待ち
                    document.getElementById('boss-1').value = state.bosses[0];
                    document.getElementById('boss-2').value = state.bosses[1];
                    document.getElementById('boss-3').value = state.bosses[2];
                }, 0);
            }
        }
    }

    function saveBoardState() {
        const boss1 = document.getElementById('boss-1')?.value || "Ongo";
        const boss2 = document.getElementById('boss-2')?.value || "Kalunga";
        const boss3 = document.getElementById('boss-3')?.value || "Mboze";

        const state = {
            board: boardState,
            players: selectedPlayerIndices,
            bosses: [boss1, boss2, boss3]
        };
        localStorage.setItem(KEY_BOARD, JSON.stringify(state));
    }

    // --- Settings Logic ---

    function parseJobString(str) {
        if(!str) return [];
        if(str.includes('全')) return [...JOBS];
        return JOBS.filter(j => str.includes(j));
    }

    function saveSettingsFromDOM() {
        const rows = document.getElementById('settings-list').children;
        // リストが空の場合は処理しない（初期ロード時など）
        if (rows.length === 0 && members.length > 0) return;

        const newMembers = [];
        for(let i=0; i<rows.length; i++) {
            const name = document.getElementById(`name-${i}`).value;
            const masterStr = document.getElementById(`master-${i}`).value;
            const lv99Str = document.getElementById(`lv99-${i}`).value;
            
            if (name || masterStr || lv99Str) {
                const mJobs = parseJobString(masterStr);
                let lJobs = parseJobString(lv99Str);
                lJobs = lJobs.filter(j => !mJobs.includes(j)); // 重複排除

                newMembers.push({
                    name: name,
                    masterStr: masterStr,
                    lv99Str: lv99Str,
                    masterJobs: mJobs,
                    lv99Jobs: lJobs
                });
            }
        }
        members = newMembers;
        localStorage.setItem(KEY_MEMBERS, JSON.stringify(members));
    }

    function renderSettingsList() {
        const container = document.getElementById('settings-list');
        container.innerHTML = '';
        members.forEach((m, idx) => {
            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <div><input type="text" value="${m.name}" id="name-${idx}" placeholder="名前" onchange="saveSettingsFromDOM()"></div>
                <div class="inputs-col">
                    <div><div class="job-label">★マスター</div><input type="text" value="${m.masterStr || ''}" id="master-${idx}" placeholder="例: 戦モ白" onchange="saveSettingsFromDOM()"></div>
                    <div><div class="job-label">Lv99</div><input type="text" value="${m.lv99Str || ''}" id="lv99-${idx}" placeholder="例: シ吟" onchange="saveSettingsFromDOM()"></div>
                </div>
                <button class="btn-action del-row" onclick="deleteMember(${idx})">×</button>
            `;
            container.appendChild(div);
        });
    }

    function addMemberRow() {
        saveSettingsFromDOM();
        members.push({name: "", masterStr: "", lv99Str: "", masterJobs: [], lv99Jobs: []});
        renderSettingsList();
        saveSettingsFromDOM(); 
    }

    function deleteMember(targetIdx) {
        if(!confirm('削除しますか？')) return;

        saveSettingsFromDOM(); // 現在の入力を保存

        // 1. 配列から削除
        members.splice(targetIdx, 1);
        localStorage.setItem(KEY_MEMBERS, JSON.stringify(members));

        // 2. 作戦ボードのインデックス参照を修正 (ここが修正ポイント)
        for(let r=0; r<6; r++) {
            const currentP = selectedPlayerIndices[r];
            if (currentP === targetIdx) {
                // 削除された人を指していた -> 未選択にする
                selectedPlayerIndices[r] = -1;
                boardState[r] = [null, null, null]; // ジョブ配置もクリア
            } else if (currentP > targetIdx) {
                // 削除された人より後ろの人 -> インデックスを詰める
                selectedPlayerIndices[r] = currentP - 1;
            }
        }
        saveBoardState(); // 修正した状態を保存

        renderSettingsList();
    }

    // --- Board Logic ---

    function initBoardUI() {
        const selects = document.querySelectorAll('.boss-select');
        selects.forEach((sel, i) => {
            sel.innerHTML = BOSS_DATA.map(b => `<option value="${b.name}">${b.name} (${b.weak})</option>`).join('');
            // デフォルト値
            if(i===0) sel.value = "Ongo"; if(i===1) sel.value = "Kalunga"; if(i===2) sel.value = "Mboze";
        });

        const grid = document.getElementById('battle-grid');
        grid.innerHTML = '';
        for(let r=0; r<6; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'grid-row';
            
            // Player Column
            const pCol = document.createElement('div');
            pCol.className = 'player-col';
            
            const pSel = document.createElement('select');
            pSel.className = 'player-select';
            // 変更時処理
            pSel.onchange = (e) => { 
                selectedPlayerIndices[r] = parseInt(e.target.value); 
                validateRowJobs(r); 
                saveBoardState(); // 保存
                refreshBoard(); 
            };
            pCol.appendChild(pSel);
            
            const pJobs = document.createElement('div');
            pJobs.className = 'player-jobs-preview';
            pJobs.id = `player-jobs-${r}`;
            pCol.appendChild(pJobs);
            rowDiv.appendChild(pCol);

            // Battle Slots
            for(let c=0; c<3; c++) {
                const slot = document.createElement('div');
                slot.className = 'job-slot';
                slot.id = `slot-${r}-${c}`;
                slot.onclick = () => handleSlotClick(r, c);
                slot.ondragover = (e) => e.preventDefault();
                slot.ondrop = (e) => { e.preventDefault(); setJob(r, c, e.dataTransfer.getData("text")); };
                rowDiv.appendChild(slot);
            }
            grid.appendChild(rowDiv);
        }
    }

    function refreshBoard() {
        const selects = document.querySelectorAll('.player-select');
        
        selects.forEach((sel, r) => {
            // 安全策: インデックスが範囲外なら未選択(-1)に戻す
            if (selectedPlayerIndices[r] >= members.length) {
                selectedPlayerIndices[r] = -1;
            }
            const currentVal = selectedPlayerIndices[r];
            
            // Option生成
            let html = `<option value="-1" ${currentVal === -1 ? 'selected' : ''}>-- 選択 --</option>`;
            
            members.forEach((m, idx) => {
                // 他行での使用状況チェック
                const isSelectedElsewhere = selectedPlayerIndices.some((val, rowIdx) => rowIdx !== r && val === idx);
                const disabledAttr = isSelectedElsewhere ? 'disabled style="color:#ccc"' : '';
                const nameLabel = m.name + (isSelectedElsewhere ? ' (選択済)' : '');
                const selectedAttr = (idx === currentVal) ? 'selected' : '';
                
                html += `<option value="${idx}" ${selectedAttr} ${disabledAttr}>${nameLabel}</option>`;
            });
            sel.innerHTML = html;
            // 明示的にvalueをセット（innerHTML入れ替え後の念のため）
            sel.value = currentVal; 
            
            // プレビュー表示
            const previewDiv = document.getElementById(`player-jobs-${r}`);
            if (currentVal !== -1 && members[currentVal]) {
                const mJobs = members[currentVal].masterJobs.map(j => `<span class="job-star">${j}</span>`).join(' ');
                const nJobs = members[currentVal].lv99Jobs.map(j => `<span class="job-norm">${j}</span>`).join(' ');
                
                if (members[currentVal].masterStr.includes('全')) previewDiv.innerHTML = '<span class="job-star">全マスター</span>';
                else if (members[currentVal].lv99Str.includes('全')) previewDiv.innerHTML = '<span class="job-norm">全Lv99</span>';
                else previewDiv.innerHTML = (mJobs + ' ' + nJobs).trim();
            } else {
                previewDiv.textContent = "";
            }
        });

        const usedJobs = new Set();
        boardState.forEach(row => row.forEach(j => { if(j) usedJobs.add(j); }));

        for(let r=0; r<6; r++) {
            const pIdx = selectedPlayerIndices[r];
            const player = (pIdx !== -1) ? members[pIdx] : null;

            for(let c=0; c<3; c++) {
                const slot = document.getElementById(`slot-${r}-${c}`);
                const currentJob = boardState[r][c];
                
                slot.innerHTML = currentJob || "";
                slot.className = 'job-slot'; 

                // ジョブ配置済み
                if (currentJob) {
                    slot.classList.add('has-job');
                    if(player && player.masterJobs.includes(currentJob)) {
                        slot.innerHTML += '<span class="slot-mark-master">★</span>';
                    }
                }
                
                // プレイヤー未選択ならスロット無効
                if (!player) {
                    slot.classList.add('disabled');
                    continue; 
                }

                // ガイド表示
                if (selectedJob) {
                    const isGlobalUsed = usedJobs.has(selectedJob) && currentJob !== selectedJob;
                    const isMaster = player.masterJobs.includes(selectedJob);
                    const isLv99 = player.lv99Jobs.includes(selectedJob);

                    if ((!isMaster && !isLv99) || isGlobalUsed) {
                        slot.classList.add('disabled');
                    } else {
                        if(isMaster) slot.classList.add('target-master');
                        else if(isLv99) slot.classList.add('target-lv99');
                    }
                }
            }
        }
        renderDeck(usedJobs);
    }

    function renderDeck(usedJobs) {
        const container = document.getElementById('deck-grid');
        container.innerHTML = '';
        const msg = document.getElementById('deck-message');

        if (!selectedJob) {
            msg.textContent = "ジョブを選択してください";
            msg.style.color = "#007bff";
        } else {
            msg.textContent = `「${JOB_FULLNAMES[selectedJob]}」を選択中...`;
            msg.style.color = "#d9534f";
        }
        
        JOBS.forEach(job => {
            const btn = document.createElement('div');
            btn.className = 'job-chip';
            if (usedJobs.has(job)) btn.classList.add('used');
            if (selectedJob === job) btn.classList.add('selected');
            btn.textContent = JOB_FULLNAMES[job];
            
            const action = () => {
                if(usedJobs.has(job)) return;
                selectedJob = (selectedJob === job) ? null : job;
                refreshBoard();
            };
            
            btn.onclick = action;
            btn.draggable = true;
            btn.ondragstart = (e) => {
                if(usedJobs.has(job)) { e.preventDefault(); return; }
                e.dataTransfer.setData("text", job);
                selectedJob = job; 
                refreshBoard();
            };
            container.appendChild(btn);
        });
    }

    function handleSlotClick(r, c) {
        // プレイヤー未選択なら何もしない
        if (selectedPlayerIndices[r] === -1) return;

        if (selectedJob) setJob(r, c, selectedJob);
        else if (boardState[r][c]) setJob(r, c, null);
    }

    function setJob(r, c, job) {
        const pIdx = selectedPlayerIndices[r];
        if (pIdx === -1) return; // プレイヤー未選択
        
        const player = members[pIdx];

        if (!job) {
            boardState[r][c] = null;
            selectedJob = null; 
            saveBoardState(); // 保存
            refreshBoard();
            return;
        }

        const isMaster = player.masterJobs.includes(job);
        const isLv99 = player.lv99Jobs.includes(job);

        if (!isMaster && !isLv99) return; 

        const isUsed = boardState.some((row, rr) => 
            row.some((j, cc) => j === job && !(rr === r && cc === c))
        );
        if (isUsed) { alert(`${job} は既に使用されています`); return; }

        boardState[r][c] = job;
        selectedJob = null; 
        saveBoardState(); // 保存
        refreshBoard();
    }

    function validateRowJobs(r) {
        const pIdx = selectedPlayerIndices[r];
        if(pIdx === -1) {
            boardState[r] = [null, null, null];
            return;
        }
        
        const player = members[pIdx];
        if(!player) return;

        for(let c=0; c<3; c++) {
            const job = boardState[r][c];
            if(job && !player.masterJobs.includes(job) && !player.lv99Jobs.includes(job)) {
                boardState[r][c] = null; 
            }
        }
    }
</script>
</body>
</html>
